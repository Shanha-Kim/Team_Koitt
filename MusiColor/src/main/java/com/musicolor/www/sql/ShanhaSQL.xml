<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
			PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="sSQL">
	<select id="SearchBefore"  resultType="fVO">
	<![CDATA[    
		SELECT
			*
		FROM
			(SELECT
				b_no no, (SELECT a_sname FROM albumpicture WHERE b_ano = a_no) sname
			FROM
				board
			WHERE
				b_emotion = 2
			ORDER BY DBMS_RANDOM.value
			)
		WHERE
			rownum <= 9
	]]>
	</select>
	
	<select id="showDetail" parameterType="bVO"  resultType="bVO">
		SELECT
			(SELECT m_id FROM member WHERE b_mno=m_no) m_id, 
			(SELECT p_sname FROM profilepicture WHERE p_no=(SELECT m_pno FROM member WHERE m_no=b_mno)) sname, 
			(SELECT y_link FROM youtube WHERE y_no=b_yno) y_link,
			(SELECT s_title FROM song WHERE s_no=b_sno) s_title,
			b_like, b_body, b_date
		FROM
			board
		WHERE
			b_no = #{b_no}
	</select>
	<select id="showComt" parameterType="bVO" resultType="cmVO">
		SELECT c_no, c_bno, c_mno, c_like, c_upno, c_date, c_isshow, c_body, (SELECT m_id from member where m_no=c_mno) c_mid
			FROM
		(SELECT * FROM comt WHERE c_bno = #{b_no})	
	</select>
	<insert id="ComtWrite" parameterType="cmVO">
		INSERT INTO comt VALUES(
			(SELECT NVL(max(c_no)+1, 100000000001) FROM comt), #{c_bno}, 
			(SELECT m_no FROM member WHERE m_id = #{c_mid}), 0, null, sysdate, 'Y', #{c_body}
		)
	</insert>
	<select id="ComtAppend" parameterType="cmVO" resultType="long">
		SELECT c_no FROM comt WHERE 
		c_bno = #{c_bno} AND
		c_mno = (SELECT m_no FROM member WHERE m_id = #{c_mid}) AND
		c_body = #{c_body}
	
	</select>
	
	
	<select id="LikeCheck" parameterType="bVO" resultType="int">
		SELECT count(*) FROM boardlike 
		WHERE 
			bl_bno=#{b_no} AND 
			bl_mno = (SELECT m_no FROM member WHERE m_id = #{m_id})
	</select>
	<insert id="LikeProcIns" parameterType="bVO">
		INSERT INTO
			boardlike
		VALUES(
			(SELECT NVL(max(bl_no)+1, 100000000001) FROM boardlike), #{b_no}, 
			(SELECT m_no FROM member WHERE m_id = #{m_id}), 'Y'
		)
	</insert>
	<update id="LikeProcPlus" parameterType="bVO">
		UPDATE
			board
		SET
			b_like = b_like + 1
		WHERE
			b_no = #{b_no}
	</update>
	<select id="LikeYorN" parameterType="bVO" resultType="bVO">
		SELECT bl_isshow b_isshow FROM boardlike
		WHERE
			bl_bno = #{b_no} AND 
			bl_mno = (SELECT m_no FROM member WHERE m_id = #{m_id})
	</select>
	<update id="LikeProcY" parameterType="bVO">
		UPDATE
			boardlike
		SET
			bl_isshow = 'Y'
		WHERE
			bl_bno = #{b_no} AND 
			bl_mno = (SELECT m_no FROM member WHERE m_id = #{m_id})
	</update>
	<update id="LikeProcN" parameterType="bVO">
		UPDATE
			boardlike
		SET
			bl_isshow = 'N'
		WHERE
			bl_bno = #{b_no} AND 
			bl_mno = (SELECT m_no FROM member WHERE m_id = #{m_id})
	</update>
	<update id="LikeProcMinus" parameterType="bVO">
		UPDATE
			board
		SET
			b_like = b_like - 1
		WHERE
			b_no = #{b_no}
	</update>
	
	<select id="LikeProcSel" parameterType="bVO"  resultType="bVO">
		SELECT
			b_like
		FROM
			board
		WHERE
			b_no = #{b_no}
	</select>
	
	<select id="SearchAfter"  resultType="fVO" parameterType="bVO">
		SELECT
			*
		FROM
			(SELECT
				b_no no, (SELECT a_sname FROM albumpicture WHERE b_ano = a_no) sname
			FROM
				board
			WHERE
				<if test="key_tab != null and key_tab == 'All'">
					b_sno = (SELECT s_no FROM song WHERE s_title = #{key_main}) OR
					b_vno = (SELECT v_no FROM vocal WHERE v_name = #{key_main}) OR
					b_mno = (SELECT m_no FROM member WHERE m_id = #{key_main}) OR
					b_body like '%#'||#{key_main}||'%'
				</if>
				<if test="key_tab != null and key_tab == 'Song'">
					b_sno = (SELECT s_no FROM song WHERE s_title = #{key_main})
				</if>
				<if test="key_tab != null and key_tab == 'Artist'">
					b_vno = (SELECT v_no FROM vocal WHERE v_name = #{key_main})	
				</if>
				<if test="key_tab != null and key_tab == 'User'">
					b_mno = (SELECT m_no FROM member WHERE m_id = #{key_main})
				</if>
				<if test="key_tab != null and key_tab == 'Hashtag'">
					b_body like '%#'||#{key_main}||'%'
				</if>
			ORDER BY 
				DBMS_RANDOM.value
			)
		WHERE
	<![CDATA[    
 			rownum <= 9
 	]]> 
	</select>
	<select id="PreView"  resultType="fVO" parameterType="bVO">
	<![CDATA[    
		SELECT
			*
		FROM
			(SELECT
				b_no, (SELECT a_sname FROM albumpicture WHERE b_ano = a_no) sname
			FROM
				board
			WHERE
				b_sno = (SELECT s_no FROM song WHERE s_title = #{key_main}) OR
				b_vno = (SELECT v_no FROM vocal WHERE v_name = #{key_main}) OR
				b_mno = (SELECT m_no FROM member WHERE m_id = #{key_main}) OR
				b_body like '%#'||#{key_main}||'%'
			ORDER BY DBMS_RANDOM.value
			)
		WHERE
			rownum <= 9
	]]>
	</select>
	
</mapper>


